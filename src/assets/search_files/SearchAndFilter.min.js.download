var SearchAndFilter=function(n,t){"use strict";function r(t,i,r,u,f){this._model=i;this._dataSource=f;this._initialTableOptions=u;this._$processingElement=null;this._tableElement=r;this.$rootElement=n(t);this.$table=null;this.filters=[];this.template=new TemplateV4(this.$rootElement.get(0),this._model);this.initialized=n.Deferred();this.filterResetInProgress}function u(n,t){var i;typeof Event=="function"?i=new Event(t,{bubbles:!0}):(i=document.createEvent("Event"),i.initEvent(t,!0,!0));n.dispatchEvent(i)}function l(n){return n instanceof Array?n:[n]}var i=function(n){function t(t,i){this.$element=n(t);this.Model=i}function e(n,i){t.call(this,n,i);Object.defineProperty(this,"Value",{enumerable:!0,get:function(){return this.Model.Value}});this.$element.find("input[type='text']").on("keyup",function(n){n.keyCode===13&&u(this,o.filterChangedEvent)});this.$element.find("input[type='submit']").on("click",function(){u(this,o.filterChangedEvent)})}function r(r,f){var e=this;t.call(this,r,f);this._selectFilterOptionResultCounts=[];Object.defineProperty(this,"Value",{enumerable:!0,get:function(){return this.Model.SelectedValues}});this.$element.fSelect({placeholder:"",numDisplayed:1,overflowText:"{n} items selected",showSearch:!1,optionFormatter:function(t){var i=n(t),r=n("<div><\/div>"),f=i.find(".fs-option-label").clone(),u=n("<div><\/div>");return u.addClass("fs-results-count"),r.append(f).append(u),i.find(".fs-option-label").replaceWith(r),i[0].outerHTML}});this.$element.change(function(){u(this,i.Constants.filterChangedEvent)})}function f(n,r){t.call(this,n,r);this.$element.change(function(){u(this,i.Constants.filterChangedEvent)})}var o={filterChangedEvent:"filterchanged",filterCreatedEvent:"filtercreated"};return t.prototype={dataItemMatches:function(){return!0},_getValueFromDataProperty:function(n){return n.hasOwnProperty(this.Model.SearchInProperty)?n[this.Model.SearchInProperty]:(console.error("Could not find property with name "+this.Model.SearchInProperty+" in data object."),null)}},e.prototype=Object.create(t.prototype),e.prototype.constructor=t,e.prototype.dataItemMatches=function(n){var i,t,r;return this.Value===undefined||this.Value===null||this.Value===""?!0:(i=this.Value.split(","),t=this._getValueFromDataProperty(n),t!==null?(r=t.toString().toLocaleLowerCase(),i.every(function(n){var t=n.trim().toLocaleLowerCase();return r.indexOf(t)>=0})):!0)},e.prototype.getValueForAnalytics=function(){return this.Value===undefined||this.Value===null||this.Value===""?"":this.Value.toString().trim()},r.prototype=Object.create(t.prototype),r.prototype.constructor=t,r.prototype._valueToArray=function(){return this.Value===undefined||this.Value===null||this.Value===""?[]:this.Value instanceof Array?this.Value:[this.Value]},r.prototype._normalizeDataValues=function(n){return n===null?null:n instanceof Array?n.map(function(n){return n.toString().trim()}):n.toString().split(",").map(function(n){return n.toString().trim()})},r.prototype.dataItemMatches=function(n){var t,i;return(i=this._valueToArray(),i.length===0)?!0:(t=this._getValueFromDataProperty(n),t=this._normalizeDataValues(t),t!==null?i.every(function(n){return n!==undefined&&n!==null&&t.indexOf(n.toString())>=0}):!0)},r.prototype.calculateLookAhead=function(n){for(var f,i,u=this.Model.Options,o=this.$element[0].hasAttribute("multiple"),r=[],e,t=0;t<n.length;t++)e={dataValue:this._normalizeDataValues(this._getValueFromDataProperty(n[t]))},o&&(e.matchesCurrentSelection=this.dataItemMatches(n[t])),r.push(e);for(t=0;t<u.length;t++){if(f=0,u[t].Value==="")f=n.length;else for(i=0;i<r.length;i++)o&&r[i].matchesCurrentSelection===!1||r[i].dataValue!==null&&r[i].dataValue.indexOf(u[t].Value)>=0&&f++;this.$element.closest(".fs-wrap").find('div[data-value="'+u[t].Value+'"].fs-option').find(".fs-results-count").text(f)}},r.prototype.reset=function(){this.$element.val("");this.$element.fSelect("reload")},r.prototype.getValueForAnalytics=function(){for(var i=this._valueToArray(),t=[],n=0;n<this.Model.Options.length;n++)i.indexOf(this.Model.Options[n].Value)>=0&&t.push(this.Model.Options[n].Text);return t.join()},f.prototype=Object.create(t.prototype),f.prototype.constructor=t,f.prototype.dataItemMatches=function(n){var t;return t=this._getValueFromDataProperty(n),t!==null?!this.Model.IsChecked||t.toString()==="true":!0},f.prototype.reset=function(){this.Model.IsChecked=!1},f.prototype.getValueForAnalytics=function(){return this.Model.IsChecked?this.Model.Label:""},{Constants:o,FreeTextFilter:e,SelectFilter:r,CheckboxFilter:f}}(n,t),f=function(n,t){var f=function(n,i){var u={name:"FilterState"};u[f.prototype.EventNameUrlParameterChanged]=function(n){if(t.history.replaceState){var r=new i(t.location.href);r.setQuery(n.ParameterKey,n.ParameterValue);history.replaceState({dummyState:!0},"",r.toString())}else return};u[r.prototype.EventNameTableRedrawn]=function(){var f={},e,s,o,u=n.filters,r,h;if(t.history.replaceState){for(o=new i(t.location.href),r=0;r<u.length;r++)(e=u[r].Model.SearchInProperty,f.hasOwnProperty(e)===!1&&(f[e]=[]),u[r].Value===undefined||u[r].Value===""||u[r].Value===null||u[r].Value instanceof Array&&u[r].Value.length===0)||(s=l(u[r].Value),f[e]=f[e].concat(s));for(h in f)o.removeQuery(h);o.addQuery(f);history.replaceState({dummyState:!0},"",o.toString())}else return};n.template.addObserver(u)};f.prototype.EventNameUrlParameterChanged="urlParameterChanged";var e=function(r){function h(){n(".advanced-filter-subsection").fadeIn(300);n(".advanced-filters-icon").fadeTo(300,0)}function e(n){return encodeURIComponent(n)}function s(){var h,t,s,o;f=!0;for(h in r.filters)t=r.filters[h],s=n.unparam(location.hash.replace("#","")),t instanceof i.FreeTextFilter&&(t.Model.Value=s.freetext),t instanceof i.SelectFilter&&(o=s[e(t.Model.Label)],o!=null&&(t.$element.val(o.split(",")),t.$element.fSelect("reload"))),t instanceof i.CheckboxFilter&&(o=s[e(t.Model.Label)],o!=null&&(t.Model.IsChecked=!0,u(t.$element.get(0),i.Constants.filterChangedEvent)));f=!1}var o={name:"FilterStateHash"},f;document.addEventListener("beforeDataLoad",function(){t.addEventListener("hashchange",s,!1);s()});t.location.hash&&h();f=!1;o[i.Constants.filterChangedEvent]=function(){var u,s,t,o;if(!f){u={};for(s in r.filters)t=r.filters[s],t instanceof i.SelectFilter?(o=e(t.Model.Label),t.Model.SelectedValues.length>0&&(u[o]=t.Model.SelectedValues.join())):t instanceof i.CheckboxFilter?(o=e(t.Model.Label),t.Model.IsChecked&&(u[o]=!0)):t instanceof i.FreeTextFilter&&t.Model.Value!=""&&t.Model.Value!=null&&(u.freetext=t.Value);location.hash=n.param(u)}};r.template.addObserver(o)},o=function(n){function s(){var u=n.$table.data(),r,i;if(n.initialized.state()==="pending")throw"Widget has not completed initialization. Wrong execution order.";for(r=0;r<u.length;r++)f.push([]);for(i=0;i<t.length;i++)e(i)}function e(i){var u=n.$table.data(),e,r;if(n.initialized.state()==="pending")throw"Widget has not completed initialization. Data matching calculations should only be called once the widget is ready.";for(r=0;r<u.length;r++)e=t[i].dataItemMatches(u[r]),f[r][i]=e}function h(i){var r;if(n.initialized.state()!=="pending"){if(r=t.indexOf(i.filter),r<0){console.error("Filter did not exist on widget");return}e(r)}}function o(){var e=[],s,r,o,u,i;if(n.initialized.state()!=="pending"){for(s=n.$table.data(),i=0;i<t.length;i++)e.push([]);for(i=0;i<f.length;i++)for(r=0;r<t.length;r++){for(o=!0,u=0;u<t.length;u++)u!==r&&(o=o&&f[i][u]);o&&e[r].push(s[i])}for(i=0;i<e.length;i++)"function"==typeof t[i].calculateLookAhead&&t[i].calculateLookAhead(e[i])}}var u={name:"LookaheadResultsCount"},f=[],t=[];u[i.Constants.filterCreatedEvent]=function(i){t.push(i.filter);n.initialized.state()!=="pending"&&e(t.length-1)};u[i.Constants.filterChangedEvent]=h;u[r.prototype.EventNameTableRedrawn]=o;n.initialized.then(function(){s();o()});n.template.addObserver(u)},s=function(n,i,u,f){var o={},s,e;e=t[i]!==undefined&&u&&f;e?s=t[i]:console.warn("Not all required parameters were provided. Event tracking is disabled and will only be mocked.");o[r.prototype.EventNameTableRedrawn]=function(){for(var i=[],t,o={},h,r=0;r<n.filters.length;r++)"function"==typeof n.filters[r].getValueForAnalytics&&(t=n.filters[r].getValueForAnalytics(),t!==""&&t!==null&&t!==undefined&&i.push(t));h=i.join();h&&(e?(o.event=u,o[f]=i.join(),s.push(o)):console.log("Searching for "+i.join()))};n.template.addObserver(o)};return{FilterStateInUrl:f,FilterStateInHash:e,LookaheadResultsCount:o,GoogleEventTracking:s}}(n,t),e=function(){return{name:"data-results-counter",execute:function(t){var i=n(t),u={};i.hide();u.name="Results counter";u[r.prototype.EventNameTableRedrawn]=function(n){var t=n.widget.$table.page.info().recordsDisplay;i.find(".number").text(t);i.is(":hidden")&&i.show()};this.addObserver(u)}}},o=function(){return{name:"advanced-search-root",execute:function(t,i){function o(){r.AdvancedSearchDisplayed?(u.find(".advanced-filter-subsection").fadeIn(300),u.find(".advanced-filters-icon").fadeTo(300,0)):(u.find(".advanced-filter-subsection").fadeOut(300),u.find(".advanced-filters-icon").fadeTo(300,1))}var u=n(t),e,r;e=t.getAttribute("advanced-search-root");r=e?this.helpers.call(this).pathfinder(e,i):i;Object.defineProperty(r,"Message",{get:function(){return this.AdvancedSearchDisplayed?this.HideAdvancedFiltersCaption:this.ShowAdvancedFiltersCaption},enumerable:!0});this.addObserver({toggleAdvancedFiltersClicked:function(n){r.AdvancedSearchDisplayed=!r.AdvancedSearchDisplayed;o();n.context.settings.subject.notify(f.FilterStateInUrl.prototype.EventNameUrlParameterChanged,{ParameterKey:"AdvancedSearchDisplayed",ParameterValue:r.AdvancedSearchDisplayed})}})}}},s=function(){return{name:"search-filter",execute:function(n,t){var u,e,r,f=this;u=n.getAttribute("search-filter").split(",").map(function(n){return n.trim()});e=u[0];r=u.length>1?this.helpers.call(this).pathfinder(u[1],t):t;this.ready().then(function(){var t;switch(e){case"freetext":t=new i.FreeTextFilter(n,r);break;case"selectfilter":t=new i.SelectFilter(n,r);break;case"checkboxfilter":t=new i.CheckboxFilter(n,r);break;default:console.error("Unknown filter type "+e);return}n.addEventListener(i.Constants.filterChangedEvent,function(u){return f.settings.subject.notify(i.Constants.filterChangedEvent,{element:n,data:r,event:u,context:f,filter:t})});f.settings.subject.notify(i.Constants.filterCreatedEvent,{element:n,data:r,event:null,context:f,filter:t})})}}},h=function(t){return{name:"reset-filters",execute:function(i){n(i).click(function(){t.resetFilters()})}}},c=function(n){return{name:"processing-element",execute:function(t){n.addProcessingIndicator(t)}}};return r.prototype.EventNameTableRedrawn="tableredrawn",r.prototype.addProcessingIndicator=function(n){this._$processingElement=this.$rootElement.find(n)},r.prototype._startProcessing=function(){this._$processingElement&&this._$processingElement.show()},r.prototype._stopProcessing=function(){this._$processingElement&&this._$processingElement.hide()},r.prototype._reloadTable=function(){this.$table.draw();this.template.settings.subject.notify(this.EventNameTableRedrawn,{element:null,data:null,event:null,context:this.template,widget:this})},r.prototype.resetFilters=function(){this.filterResetInProgressPromise=n.Deferred();for(var t=0;t<this.filters.length;t++)"function"==typeof this.filters[t].reset&&this.filters[t].reset();this.filterResetInProgressPromise.resolve();this._reloadTable()},r.prototype.init=function(){var l=this.template,t,f=this.initialized;return t={},t[i.Constants.filterCreatedEvent]=function(n){this.filters.push(n.filter);this.initialized.state()!=="pending"&&this.hasOwnProperty("reloadPending")===!1&&(this.reloadPending=!0,setTimeout(function(){this._reloadTable();delete this.reloadPending}.bind(this),50))}.bind(this),t[i.Constants.filterChangedEvent]=function(){this.initialized.state()==="pending"||this.filterResetInProgressPromise&&this.filterResetInProgressPromise.state()==="pending"||this._reloadTable()}.bind(this),l.addExtension(s(this)).addExtension(o(this)).addExtension(e(this)).addExtension(h(this)).addExtension(c(this)).addObserver(t).bindTemplate().ready().then(function(){var t=n(l.tpl);this._startProcessing();this._dataSource.promise().then(function(i){var o=n.extend({},this._initialTableOptions,{data:i}),e=t.find(this._tableElement).DataTable(o);this.$table=e;r.prototype.getTableData=function(){return e.rows({filter:"applied"}).data()};this._stopProcessing();this._reloadTable();f.resolve();u(document,"beforeDataLoad")}.bind(this)).fail(function(){f.reject()})}.bind(this)).fail(function(){f.reject()}),n.fn.dataTable.ext.search.push(function(n,t,i,r){for(var o,e=this.filters,u=!0,f=0;f<e.length;f++)o=e[f],u=u&&o.dataItemMatches(r);return u}.bind(this)),f},{SearchAndFilterWidget:r,Filters:i,WidgetExtensions:f}}(jQuery,window)